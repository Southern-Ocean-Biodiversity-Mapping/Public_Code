---
title: "Circumpolar Environmental Data"
author: "Jan Jansen"
date: "15/07/2021"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
##### load libraries
library(ncdf4)        ## package for netcdf manipulation
library(raadtools)
library(raster)       ## package for raster manipulation
library(sp)
library(dplyr)
library(blueant)
library(rgdal)        ## package for geospatial analysis
library(ggplot2)      ## package for plotting

library(spatialEco)

## polar stereographic projection:
stereo <- "+proj=stere +lat_0=-90 +lat_ts=-71 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs"
```

__Circumpolar Environmental Data:  From raw files to data ready for analysis in R__  
- read in  
- reproject  
- transform  
- ...  

To simplify making changes, crop and scale transformations can be done from a separate Script: "ReadIn_Circumpolar_Environmental_Data_CropAndScale.Rmd"

Code is not pretty, but it seems to work...

## Things you need to do to run this script

#### 1. specify the directory where to find the data

- specify your local directory or point to the owncloud directories (THIS DOESN'T WORK YET)

- Download the data from the link below and change "env.dir" in the code snippet below to match your local machine.

Owncloud repository folder is "EnvironmentalData". All data can be found here:
[link](https://owncloud.imas-data-service.cloud.edu.au/index.php/apps/files/?dir=/EnvironmentalData&fileid=186349)

```{r}
## Jan's local machine:
env.dir <- "C:/Users/jjansen/Desktop/science/data_environmental/"

## remote repository (DOESN'T WORK YET):
# env.dir <- "https://data.imas.utas.edu.au/data_transfer/admin/files/EnvironmentalData/"

## DO YOU WANT TO RUN THE CODE? This sets "eval" in MOST code chunks below:
RUN_ALL <- FALSE
```

```{r}
##### setting up directories
env.raw <- paste0(env.dir,"raw/")
env.derived <- paste0(env.dir,"derived/")
AAD_dir <- paste0(env.dir,"raw/accessed_through_R")

string.chr <- "Circumpolar_EnvData_"
string.res <- "500m_"
```

#### 2. for bathymetry: choose which data-layer to use, which resolution and projection.

```{r}
## Choose dataset
#data.name <- "ibcso"  ## ibcso can be found using Ben's AAd dataset-wrapper
#data.name <- "ibcso2"  ## DOESN'T EXIST YET, DOESN'T FUNCTION IN THE CODE YET
data.name <- "gebco"  ## gebco is on file

## Choose resolution and projection (only relevant for gebco bathymetry)
data.format <- "project.500" ## project polarstereographic to 500m resolution
#data.format <- "project.raw" ## project polarstereographic but keep resolution as it is
#data.format <- "unprojected" ## keep raw format

## Choose range of depth
data.depth <- "shelf"
#data.depth <- "full"

if(data.depth=="shelf"){
  depth.range <- c(0,-3000)
}else depth.range <- c(0,-Inf)
```

# Environmental Data {.tabset}

## AAD data

Code to download data from other remote repositories to your local machine
[link](https://ropensci.org/blog/2018/11/13/antarctic/)

```{r, warning=FALSE, message=FALSE, eval=FALSE}
## Big file-download so snippet is set to eval=FALSE
## seaice data needs login...
src <- bind_rows(sources("NSIDC SMMR-SSM/I Nasateam sea ice concentration", hemisphere = "south", time_resolutions = "day", years = c(2013)),
                 sources("Southern Ocean summer chlorophyll-a climatology (Johnson)"),
                 sources("IBCSO bathymetry"),
                 bb_modify_source(sources("Oceandata MODIS Aqua Level-3 mapped daily 4km chl-a"), method = list(search = "A2014*L3m_DAY_CHL_chlor_a_4km.nc")))
result <- bb_get(src, local_file_root = AAD_dir, clobber = 0, verbose = TRUE, confirm = NULL)
```

But usually we only need to set the directory where the AAD functions look for the data
```{r, eval=RUN_ALL}
set_data_roots(AAD_dir)
```

## Bathymetry

If it's gebco, this chunk takes 30-40mins!

```{r, eval=RUN_ALL}
## read in bathymetry data and project/reproject if needed
r <- readtopo("ibcso") ## already projected and at 500m resolution
if(data.name=="gebco"){
  ## load raw (unprojected) data
  # g <- raster(paste0(env.raw,"GEBCO_2020/gebco_2020_SO.tif"))
  # g <- raster(paste0(env.raw,"gebco_2021_sub_ice_topo/GEBCO_2021_sub_ice_topo_CF.nc"))
  # crs(g) <- "+proj=longlat +datum=WGS84 +no_defs"
  # g <- crop(g,extent(c(-180,180,-90,-60)))
  g <- raster(paste0(env.raw,"GEBCO_2021/gebco_2021_SO.tif"))
  if(data.format=="project.500"|data.format=="project.raw"){
    ## project raster to polar stereographic
    g <- projectRaster(g,crs=stereo)
  }
  if(data.format=="project.500"){
    ## change resolution to 500m grid cells
    g <- projectRaster(g,r)
  }
  r <- g  
}
```

### Transform data

This chunk takes a while, maybe 15min

```{r, eval=RUN_ALL}
## create layers for depth, slope and topographic position index (TPI) at different scales
r.depth <- r
r.slope <- terrain(r)
r.tpi <- tpi(r)
r.tpi5 <- tpi(r, scale=5)
r.tpi11 <- tpi(r, scale=11)
# r.tpi21 <- tpi(r, scale=21)
# r.tpi31 <- tpi(r, scale=31)

## set anything on land to NA, and optionally set abyssal zone to NA
r.depth[r>=0] <- NA
r.depth[r<=depth.range[2]] <- NA
r.slope[is.na(r.depth[])] <- NA
r.tpi[is.na(r.depth[])] <- NA
r.tpi5[is.na(r.depth[])] <- NA
r.tpi11[is.na(r.depth[])] <- NA
# r.tpi21[is.na(r.depth[])] <- NA
# r.tpi31[is.na(r.depth[])] <- NA

r.bathy <- stack(r.depth, r.slope, r.tpi, r.tpi5, r.tpi11)#, r.tpi21, r.tpi31)
names(r.bathy) <- c("depth","slope","tpi","tpi5","tpi11")#"tpi21","tpi31")

# # xlim=c(128,148)
# # ylim=c(-67.5,-64)
# par(mfrow=c(2,2))
# plot(r.depth) #, xlim=xlim, ylim=ylim
# plot(r.slope) #, xlim=xlim, ylim=ylim
# plot(r.tpi5)  #, xlim=xlim, ylim=ylim
# plot(r.tpi31) #, xlim=xlim, ylim=ylim
```

### Save data

```{r, eval=RUN_ALL}
if(data.name=="ibcso"){
  res.string <- string.res
  ra.string <- ""
  if(data.depth=="shelf"){
      res.string <- string.res
      ra.string <- "shelf_"
  }
}
if(data.name=="gebco"){
  if(data.depth=="full"){
    if(data.format=="project.raw"){ ## original resolution (119m x 460m)
      res.string <- ""
      ra.string <- ""
    }
    if(data.format=="project.500"){ ## 500m resolution
      res.string <- string.res
      ra.string <- ""      
    }
  }
  if(data.depth=="shelf"){
    if(data.format=="project.raw"){ ## original resolution (119m x 460m)
      res.string <- ""
      ra.string <- "shelf_"
    }
    if(data.format=="project.500"){ ## 500m resolution
      res.string <- string.res
      ra.string <- "shelf_"      
    }
  }
}
save.string <- paste0(env.derived, string.chr, res.string, ra.string, "bathy_", data.name)

# writeRaster(g, filename=paste0("C:/Users/jjansen/Desktop/science/data_environmental/derived/Circumpolar_EnvData_500m_bathy_gebco.Rdata"), overwrite=TRUE)
writeRaster(r.depth, filename=paste0(save.string,"_depth.grd"), overwrite=TRUE)
writeRaster(r.slope, filename=paste0(save.string,"_slope.grd"), overwrite=TRUE)
writeRaster(r.tpi,   filename=paste0(save.string,"_tpi.grd"), overwrite=TRUE)
writeRaster(r.tpi5,  filename=paste0(save.string,"_tpi5.grd"), overwrite=TRUE)
writeRaster(r.tpi11, filename=paste0(save.string,"_tpi11.grd"), overwrite=TRUE)
```

```{r, eval=RUN_ALL}
## optionally creating a smaller file for a single region, e.g. the Weddell Sea:
#r.bathy_smaller <- crop(r.bathy, y=extent(-2800000,0,400000,2250000))
#writeRaster(r.bathy_smaller, filename=paste0(env.derived, string.chr, res.string, ra.string, "bathy_", data.name,"Weddell.Rdata"), overwrite=TRUE)
```

## Net Primary Production

Raw NPP is being read in and manipulated using a different script as part of preparing the input for the circumpolar ocean model ("ReadIn_Circumpolar_Environmental_Data_ROMS_NPP.Rmd").    
Here, we're using the standardised files found in the derived data folder to produce NPP climatologies.  
Files that are "filled": missing npp observations where chla observation were present, were replaced with predicted values from the npp-chla relationship in the region.  

### Read data from NetCDF files

```{r, eval=RUN_ALL}
years <- as.character(2002:2020)

## npp list
npp.list <- list()

## load data:
npp.list$npp_2002 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2002.Rdata")))
npp.list$npp_2003 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2003.Rdata")))
npp.list$npp_2004 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2004.Rdata")))
npp.list$npp_2005 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2005.Rdata")))
npp.list$npp_2006 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2006.Rdata")))
npp.list$npp_2007 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2007.Rdata")))
npp.list$npp_2008 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2008.Rdata")))
npp.list$npp_2009 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2009.Rdata")))
npp.list$npp_2010 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2010.Rdata")))
npp.list$npp_2011 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2011.Rdata")))
npp.list$npp_2012 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2012.Rdata")))
npp.list$npp_2013 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2013.Rdata")))
npp.list$npp_2014 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2014.Rdata")))
npp.list$npp_2015 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2015.Rdata")))
npp.list$npp_2016 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2016.Rdata")))
npp.list$npp_2017 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2017.Rdata")))
npp.list$npp_2018 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2018.Rdata")))
npp.list$npp_2019 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2019.Rdata")))
npp.list$npp_2020 <- get(load(paste0(env.derived,string.chr,"NPP_Cafe_filled_2020.Rdata")))

## stack each month, keeping in mind:
## the year 2002 only has data for the second half of the year
## 2020 is missing September

list_01 <- list()
list_02 <- list()
list_03 <- list()
list_10 <- list()
list_11 <- list()
list_12 <- list()

for(i in 1:length(npp.list)){
  if(years[i]=="2002"){
    list_01[[i]] <- NA
    list_02[[i]] <- NA
    list_03[[i]] <- NA
    list_10[[i]] <- npp.list[[i]][[2]]
    list_11[[i]] <- npp.list[[i]][[3]]
    list_12[[i]] <- npp.list[[i]][[4]]
  }else if(years[i]=="2020"){
    list_01[[i]] <- npp.list[[i]][[1]]
    list_02[[i]] <- npp.list[[i]][[2]]
    list_03[[i]] <- npp.list[[i]][[3]]
    list_10[[i]] <- npp.list[[i]][[5]]
    list_11[[i]] <- npp.list[[i]][[6]]
    list_12[[i]] <- npp.list[[i]][[7]]
  }else{
    list_01[[i]] <- npp.list[[i]][[1]]
    list_02[[i]] <- npp.list[[i]][[2]]
    list_03[[i]] <- npp.list[[i]][[3]]
    list_10[[i]] <- npp.list[[i]][[6]]
    list_11[[i]] <- npp.list[[i]][[7]]
    list_12[[i]] <- npp.list[[i]][[8]]
  }
  names(list_01)[i] <- names(list_02)[i] <- names(list_03)[i] <- names(list_10)[i] <- names(list_11)[i] <- names(list_12)[i] <- names(npp.list)[i]
}

Jan_ave <- mean(brick(list_01[-1]), na.rm=TRUE)
Feb_ave <- mean(brick(list_02[-1]), na.rm=TRUE)
Mar_ave <- mean(brick(list_03[-1]), na.rm=TRUE)
Oct_ave <- mean(brick(list_10), na.rm=TRUE)
Nov_ave <- mean(brick(list_11), na.rm=TRUE)
Dec_ave <- mean(brick(list_12), na.rm=TRUE)

Su_ave <- mean(Jan_ave,Feb_ave,Mar_ave,Oct_ave,Nov_ave,Dec_ave, na.rm=TRUE)
writeRaster(Su_ave, filename=paste0(env.derived,string.chr,"NPP_Cafe_filled_SummerAverage.Rdata"), overwrite=TRUE)

npp_su <- projectRaster(Su_ave,r)
writeRaster(npp_su, filename=paste0(env.derived,string.chr,"500m_NPP_Cafe_filled_SummerAverage.Rdata"), overwrite=TRUE)

npp_su_shelf <- npp_su
npp_su_shelf[is.na(r.depth)] <- NA
writeRaster(npp_su_shelf, filename=paste0(env.derived,string.chr,"500m_shelf_NPP_Cafe_filled_SummerAverage.Rdata"), overwrite=TRUE)
```

## Currents & Temperature

2k res (UPDATE ONCE FAM HAS RUN)  
NetCDF-files are downloaded from GADI

```{r, eval=RUN_ALL}
## file paths
f.grd <- paste0(env.raw,"waom2_grd.nc")
f.u <- paste0(env.raw,"ocean_avg_0538-0610_u_avg.nc")
f.v <- paste0(env.raw,"ocean_avg_0538-0610_v_avg.nc")
f.t <- paste0(env.raw,"ocean_avg_0538-0610_temp_avg.nc")

## read as raster
lon <- raster(f.grd, varname="lon_rho")
lat <- raster(f.grd, varname="lat_rho")
u <- raster(f.u, lvar=3, level=1, varname="u")
v <- raster(f.v, lvar=3, level=1, varname="v")
t <- raster(f.t, lvar=3, level=1, varname="temp")

## bring to same extent (address one of the quirks of ROMS)
ext <- extent(1,3149,1,2649)
lon <- crop(lon,y=ext,snap="out")
lat <- crop(lat,y=ext,snap="out")
u <- crop(u,y=ext,snap="out")
v <- crop(v,y=ext,snap="out")
t <- crop(t,y=ext,snap="out")
#w <- crop(w,y=ext,snap="out")

## calculate a single seafloor current speed value
uv <- sqrt(abs(u)^2+abs(v)^2)
## projection and extent for the raster (netcdf files were already polar-projected with true south at -71S)
crs <- stereo ##"+proj=stere +lat_ts=-71 +lat_0=-90 +datum=WGS84"
pts <- rgdal::project(cbind(values(lon), values(lat)), crs)
ex <- extent(pts)
uv <- setExtent(uv, ex)
t <- setExtent(t, ex)
projection(uv) <- crs
projection(t) <- crs

## resample to standard 500m resolution of other environmental variables
uv_500 <- resample(uv,r)
t_500 <- resample(t,r)

## shelf only
uv_500_shelf <- uv_500
uv_500_shelf[is.na(r.depth)] <- NA
t_500_shelf <- t_500
t_500_shelf[is.na(r.depth)] <- NA

## write rasters to file
writeRaster(uv,           filename=paste0(env.derived,string.chr,"waom2k_seafloorcurrents.Rdata"))
writeRaster(uv_500,       filename=paste0(env.derived,string.chr,"500m_waom2k_seafloorcurrents.Rdata"))
writeRaster(uv_500_shelf, filename=paste0(env.derived,string.chr,"500m_shelf_waom2k_seafloorcurrents.Rdata"))
writeRaster(t,            filename=paste0(env.derived,string.chr,"waom2k_seafloortemperature.Rdata"))
writeRaster(t_500,        filename=paste0(env.derived,string.chr,"500m_waom2k_seafloortemperature.Rdata"))
writeRaster(t_500_shelf,  filename=paste0(env.derived,string.chr,"500m_shelf_waom2k_seafloortemperature.Rdata"))

# plot(uv,xlim=c(0,1000000),ylim=c(-2300000,-1500000))
# plot(coast.proj, add=TRUE)
# contour(r, add=TRUE)
```

## Seaice

__THIS DOESN'T WORK YEY - DATA ACCESS NEEDS LOGIN__  

Only the year 2013 available at the moment. Chat to Ben Raymond to fix it.

```{r, eval=FALSE}
SO.ext <- extent(-180, 180, -80, -55)

## create a raster with the native extent of the file
timespan <- as.Date(c("2013-01-01","2013-01-02","2013-01-03"))
full.extent.raster <- readice(product="nsidc", date=timespan)
full.extent.projection <- projection(full.extent.raster)

# ####### MONTHLY
# ## dates
# m_dates <- list()
# m_dates[[1]] <- seq(as.Date("2002-10-01"), as.Date("2003-04-01"), by = "1 month")
# m_dates[[2]] <- seq(as.Date("2003-10-01"), as.Date("2004-04-01"), by = "1 month")
# m_dates[[3]] <- seq(as.Date("2004-10-01"), as.Date("2005-04-01"), by = "1 month")
# m_dates[[4]] <- seq(as.Date("2005-10-01"), as.Date("2006-04-01"), by = "1 month")
# m_dates[[5]] <- seq(as.Date("2006-10-01"), as.Date("2007-04-01"), by = "1 month")
# m_dates[[6]] <- seq(as.Date("2007-10-01"), as.Date("2008-04-01"), by = "1 month")
# m_dates[[7]] <- seq(as.Date("2008-10-01"), as.Date("2009-04-01"), by = "1 month")
# m_dates[[8]] <- seq(as.Date("2009-10-01"), as.Date("2010-04-01"), by = "1 month")
# m_dates[[9]] <- seq(as.Date("2010-10-01"), as.Date("2011-04-01"), by = "1 month")
# m_dates[[10]] <- seq(as.Date("2011-10-01"), as.Date("2012-04-01"), by = "1 month")
# m_dates[[11]] <- seq(as.Date("2012-10-01"), as.Date("2013-04-01"), by = "1 month")
# m_dates[[12]] <- seq(as.Date("2013-10-01"), as.Date("2014-04-01"), by = "1 month")
# m_dates[[13]] <- seq(as.Date("2014-10-01"), as.Date("2015-04-01"), by = "1 month")
# m_dates[[14]] <- seq(as.Date("2015-10-01"), as.Date("2016-04-01"), by = "1 month")
# m_dates[[15]] <- seq(as.Date("2016-10-01"), as.Date("2017-04-01"), by = "1 month")
# m_dates[[16]] <- seq(as.Date("2017-10-01"), as.Date("2018-04-01"), by = "1 month")
# m_dates[[17]] <- seq(as.Date("2018-10-01"), as.Date("2019-04-01"), by = "1 month")
# m_dates[[18]] <- seq(as.Date("2019-10-01"), as.Date("2020-04-01"), by = "1 month")
# 

####### SEASONAL
## dates
sp_dates <- list()
su_dates <- list()
au_dates <- list()
sp_dates[[1]] <- seq(as.Date("2002-09-23"), as.Date("2002-12-20"), by = "1 day")
sp_dates[[2]] <- seq(as.Date("2003-09-23"), as.Date("2003-12-20"), by = "1 day")
sp_dates[[3]] <- seq(as.Date("2004-09-23"), as.Date("2004-12-20"), by = "1 day")
sp_dates[[4]] <- seq(as.Date("2005-09-23"), as.Date("2005-12-20"), by = "1 day")
sp_dates[[5]] <- seq(as.Date("2006-09-23"), as.Date("2006-12-20"), by = "1 day")
sp_dates[[6]] <- seq(as.Date("2007-09-23"), as.Date("2007-12-20"), by = "1 day")
sp_dates[[7]] <- seq(as.Date("2008-09-23"), as.Date("2008-12-20"), by = "1 day")
sp_dates[[8]] <- seq(as.Date("2009-09-23"), as.Date("2009-12-20"), by = "1 day")
sp_dates[[9]] <- seq(as.Date("2010-09-23"), as.Date("2010-12-20"), by = "1 day")
sp_dates[[10]] <- seq(as.Date("2011-09-23"), as.Date("2011-12-20"), by = "1 day")
sp_dates[[11]] <- seq(as.Date("2012-09-23"), as.Date("2012-12-20"), by = "1 day")
sp_dates[[12]] <- seq(as.Date("2013-09-23"), as.Date("2013-12-20"), by = "1 day")
sp_dates[[13]] <- seq(as.Date("2014-09-23"), as.Date("2014-12-20"), by = "1 day")
sp_dates[[14]] <- seq(as.Date("2015-09-23"), as.Date("2015-12-20"), by = "1 day")
sp_dates[[15]] <- seq(as.Date("2016-09-23"), as.Date("2016-12-20"), by = "1 day")
sp_dates[[16]] <- seq(as.Date("2017-09-23"), as.Date("2017-12-20"), by = "1 day")
sp_dates[[17]] <- seq(as.Date("2018-09-23"), as.Date("2018-12-20"), by = "1 day")
sp_dates[[18]] <- seq(as.Date("2019-09-23"), as.Date("2019-12-20"), by = "1 day")
sp_dates[[19]] <- seq(as.Date("2020-09-23"), as.Date("2020-12-20"), by = "1 day")

su_dates[[1]] <- seq(as.Date("2002-12-21"), as.Date("2003-03-20"), by = "1 day")
su_dates[[2]] <- seq(as.Date("2003-12-21"), as.Date("2004-03-20"), by = "1 day")
su_dates[[3]] <- seq(as.Date("2004-12-21"), as.Date("2005-03-20"), by = "1 day")
su_dates[[4]] <- seq(as.Date("2005-12-21"), as.Date("2006-03-20"), by = "1 day")
su_dates[[5]] <- seq(as.Date("2006-12-21"), as.Date("2007-03-20"), by = "1 day")
su_dates[[6]] <- seq(as.Date("2007-12-21"), as.Date("2008-03-20"), by = "1 day")
su_dates[[7]] <- seq(as.Date("2008-12-21"), as.Date("2009-03-20"), by = "1 day")
su_dates[[8]] <- seq(as.Date("2009-12-21"), as.Date("2010-03-20"), by = "1 day")
su_dates[[9]] <- seq(as.Date("2010-12-21"), as.Date("2011-03-20"), by = "1 day")
su_dates[[10]] <- seq(as.Date("2011-12-21"), as.Date("2012-03-20"), by = "1 day")
su_dates[[11]] <- seq(as.Date("2012-12-21"), as.Date("2013-03-20"), by = "1 day")
su_dates[[12]] <- seq(as.Date("2013-12-21"), as.Date("2014-03-20"), by = "1 day")
su_dates[[13]] <- seq(as.Date("2014-12-21"), as.Date("2015-03-20"), by = "1 day")
su_dates[[14]] <- seq(as.Date("2015-12-21"), as.Date("2016-03-20"), by = "1 day")
su_dates[[15]] <- seq(as.Date("2016-12-21"), as.Date("2017-03-20"), by = "1 day")
su_dates[[16]] <- seq(as.Date("2017-12-21"), as.Date("2018-03-20"), by = "1 day")
su_dates[[17]] <- seq(as.Date("2018-12-21"), as.Date("2019-03-20"), by = "1 day")
su_dates[[18]] <- seq(as.Date("2019-12-21"), as.Date("2020-03-20"), by = "1 day")

au_dates[[1]] <- seq(as.Date("2003-03-21"), as.Date("2003-06-21"), by = "1 day")
au_dates[[2]] <- seq(as.Date("2004-03-21"), as.Date("2004-06-21"), by = "1 day")
au_dates[[3]] <- seq(as.Date("2005-03-21"), as.Date("2005-06-21"), by = "1 day")
au_dates[[4]] <- seq(as.Date("2006-03-21"), as.Date("2006-06-21"), by = "1 day")
au_dates[[5]] <- seq(as.Date("2007-03-21"), as.Date("2007-06-21"), by = "1 day")
au_dates[[6]] <- seq(as.Date("2008-03-21"), as.Date("2008-06-21"), by = "1 day")
au_dates[[7]] <- seq(as.Date("2009-03-21"), as.Date("2009-06-21"), by = "1 day")
au_dates[[8]] <- seq(as.Date("2010-03-21"), as.Date("2010-06-21"), by = "1 day")
au_dates[[9]] <- seq(as.Date("2011-03-21"), as.Date("2011-06-21"), by = "1 day")
au_dates[[10]] <- seq(as.Date("2012-03-21"), as.Date("2012-06-21"), by = "1 day")
au_dates[[11]] <- seq(as.Date("2013-03-21"), as.Date("2013-06-21"), by = "1 day")
au_dates[[12]] <- seq(as.Date("2014-03-21"), as.Date("2014-06-21"), by = "1 day")
au_dates[[13]] <- seq(as.Date("2015-03-21"), as.Date("2015-06-21"), by = "1 day")
au_dates[[14]] <- seq(as.Date("2016-03-21"), as.Date("2016-06-21"), by = "1 day")
au_dates[[15]] <- seq(as.Date("2017-03-21"), as.Date("2017-06-21"), by = "1 day")
au_dates[[16]] <- seq(as.Date("2018-03-21"), as.Date("2018-06-21"), by = "1 day")
au_dates[[17]] <- seq(as.Date("2019-03-21"), as.Date("2019-06-21"), by = "1 day")
au_dates[[18]] <- seq(as.Date("2020-03-21"), as.Date("2020-06-21"), by = "1 day")

## spring-raster
ice_spring <- stack(readice(sp_dates[[1]], grid = raster(ext=SO.ext, crs=full.extent.projection, res=1/24)))
names(chla_spring)[1] <- paste0("chla_",su_years[1])
for(i in 2:length(sp_dates){
  message(i)
  chla_spring[[i]] <- readchla(sp_dates[[i]], algorithm="johnson", product="MODISA", grid = raster(ext=SO.ext, crs=full.extent.projection, res=1/24))
  names(chla_spring)[i] <- paste0("chla_",years[i])
}
save(chla_spring, file="Circumpolar_EnvData_ChlA_spring.Rdata")
rm(chla_spring)

## summer-raster
chla_summer <- stack(readchla(su_dates[[1]], algorithm="johnson", product="MODISA", grid = raster(ext=SO.ext, crs=full.extent.projection, res=1/24)))
names(chla_summer)[1] <- paste0("chla_",su_years[1])
for(i in 2:length(su_dates)){
  message(i)
  chla_summer[[i]] <- readchla(su_dates[[i]], algorithm="johnson", product="MODISA", grid = raster(ext=SO.ext, crs=full.extent.projection, res=1/24))
  names(chla_summer)[i] <- paste0("chla_",su_years[i])
}
save(chla_summer, file="Circumpolar_EnvData_ChlA_summer.Rdata")
rm(chla_summer)

## autumn-raster
chla_autumn <- stack(readchla(au_dates[[1]], algorithm="johnson", product="MODISA", grid = raster(ext=SO.ext, crs=full.extent.projection, res=1/24)))
names(chla_autumn)[1] <- paste0("chla_",years[2])
for(i in 2:length(au_dates)){
  message(i)
  chla_autumn[[i]] <- readchla(au_dates[[i]], algorithm="johnson", product="MODISA", grid = raster(ext=SO.ext, crs=full.extent.projection, res=1/24))
  names(chla_autumn)[i] <- paste0("chla_",years[i+1])
}
save(chla_autumn, file="Circumpolar_EnvData_ChlA_autumn.Rdata")
rm(chla_autumn)
```

```{r, eval=RUN_ALL}
#### seascapes
# tpi_small <- r.tpi5
# tpi_large <- r.tpi31
# ## calculate mean:
# m.s <- cellStats(tpi_small, 'mean')
# m.l <- cellStats(tpi_large, 'mean')
# ## calculate sd:
# sd.s <- cellStats(tpi_small, 'sd')
# sd.l <- cellStats(tpi_large, 'sd')
# ## Standardize the TPI grids using the formula:
# ## tpi<sf>_stdi = int((((tpi<sf> â€“ mean) / stdv) * 100) + 0.5)
# t.s_stdi <- calc(tpi_small, function(x) (((x - m.s) / sd.s) * 100) + 0.5)
# t.l_stdi <- calc(tpi_large, function(x) (((x - m.l) / sd.l) * 100) + 0.5)
# ## set low and high values to classify the landforms
# v_low <- -100
# v_high <- 100
# ## specify the function, using ifelse to decide between cases: (x is t31..., y is t201..., z is slope)
# my_fun <- function(x,y,z){
#   ifelse (x > v_low & x < v_high & y > v_low & y < v_high & z <= 5, 5, 
#           ifelse(x > v_low & x < v_high & y > v_low & y < v_high & z >= 5, 6,   #Jeroen:>5, vorher>=6
#                  ifelse(x > v_low & x < v_high & y >= v_high, 7,
#                         ifelse(x > v_low & x < v_high & y <= v_low, 4,
#                                ifelse(x <= v_low & y > v_low & y < v_high, 2,
#                                       ifelse(x >= v_high & y > v_low & y < v_high, 9,
#                                              ifelse(x <= v_low & y >= v_high, 3,
#                                                     ifelse(x <= v_low & y <= v_low, 1,
#                                                            ifelse(x >= v_high & y >= v_high, 10,
#                                                                   ifelse(x >= v_high & y <= v_low, 8, NA)
#                                                            )))))))))
# }
# ## do the calculation (we run my_fun on the three raster layers)
# land_s_l <- overlay(stack(t.s_stdi,t.l_stdi,r.slope), fun=my_fun)
# plot(land_s_l, xlim=c(138,148), ylim=c(-68,-65))
```